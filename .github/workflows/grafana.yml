name: Test Grafana Setup

on:
  pull_request:
    branches: [ main ]
  push:
    branches: [ main ]

jobs:
  grafana-setup:
    name: Test Grafana install
    runs-on: ubuntu-24.04

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
      
      - name: Build kpi-collector
        run: go build -o kpi-collector ./cmd/kpi-collector

      - name: Start Grafana via kpi-collector
        run: | 
          # Detect container runtime (same logic as the tool)
          if command -v podman &> /dev/null && podman info &> /dev/null; then
            RUNTIME="podman"
          else
            RUNTIME="docker"
          fi
          echo "Using container runtime: $RUNTIME"

          # Start Grafana with SQLite datasource
          ./kpi-collector grafana start --datasource=sqlite

          # Wait for Grafana to start
          sleep 20

          # Verify container is running
          $RUNTIME ps | grep grafana-kpi

          # Verify provisioning files exist
          $RUNTIME exec grafana-kpi ls -l /etc/grafana/provisioning/dashboards/dashboards.yaml
          $RUNTIME exec grafana-kpi ls -l /var/lib/grafana/dashboards/dashboard.json
          $RUNTIME exec grafana-kpi ls -l /etc/grafana/provisioning/datasources/

          # Verify datasource is loaded in Grafana via API
          $RUNTIME exec grafana-kpi curl -s -u admin:admin http://localhost:3000/api/datasources | grep -E "(frser-sqlite-datasource|KPI-SQLite)" || echo "Datasource not found"

          # Verify dashboard is loaded in Grafana via API
          $RUNTIME exec grafana-kpi curl -s -u admin:admin \
          "http://localhost:3000/api/search?query=KPI" | grep -E "(Certsuite KPI per Cluster|KPI Collection Tool)" || echo "Dashboard not found"
      - name: Clean up Grafana container
        run: ./kpi-collector grafana stop || true